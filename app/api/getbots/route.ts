import { type NextRequest, NextResponse } from "next/server"
import { supabase } from "@/lib/supabase"

export async function GET(request: NextRequest) {
  try {
    // Obter API key do cabe√ßalho
    const apiKey =
      request.headers.get("x-api-key") ||
      request.headers.get("authorization")?.replace("Bearer ", "") ||
      request.headers.get("x-auth-token")

    if (!apiKey) {
      console.log("‚ùå API key n√£o fornecida")
      return NextResponse.json({ error: "API key n√£o fornecida" }, { status: 401 })
    }

    console.log("üîë Verificando API key:", apiKey.substring(0, 10) + "...")

    // Verificar se a API key existe
    const { data: userData, error: userError } = await supabase
      .from("user_profiles")
      .select("id, email, role, status")
      .eq("api_key", apiKey)
      .eq("status", "active")
      .single()

    if (userError || !userData) {
      console.log("‚ùå API key inv√°lida ou usu√°rio inativo")
      return NextResponse.json({ error: "API key inv√°lida ou usu√°rio inativo" }, { status: 401 })
    }

    console.log("‚úÖ API key v√°lida para usu√°rio:", userData.email)

    // Buscar bots do usu√°rio
    const { data: bots, error: botsError } = await supabase
      .from("ai_agents")
      .select(`
        id, 
        name, 
        description, 
        status, 
        model, 
        temperature,
        transcribe_audio,
        understand_images,
        voice_response_enabled,
        voice_provider,
        voice_id,
        calendar_integration,
        chatnode_integration,
        orimon_integration,
        whatsapp_connection_id,
        whatsapp_connections:whatsapp_connection_id (
          connection_name,
          instance_name,
          phone_number,
          status
        )
      `)
      .eq("user_id", userData.id)
      .eq("status", "active")

    if (botsError) {
      console.error("‚ùå Erro ao buscar bots:", botsError)
      return NextResponse.json({ error: "Erro ao buscar bots" }, { status: 500 })
    }

    console.log(`‚úÖ ${bots?.length || 0} bots encontrados`)

    return NextResponse.json({
      success: true,
      bots: bots || [],
    })
  } catch (error: any) {
    console.error("üí• Erro geral:", error)
    return NextResponse.json({ error: "Erro interno do servidor" }, { status: 500 })
  }
}
