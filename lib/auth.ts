import { supabase } from "@/lib/supabase"
import bcrypt from "bcryptjs"

export interface UserProfile {
  id: string
  email: string
  full_name: string
  role: "admin" | "user"
  status: "active" | "inactive"
  created_at: string
  updated_at: string
  last_login_at?: string
}

export interface LoginCredentials {
  email: string
  password: string
}

export interface RegisterData {
  email: string
  password: string
  full_name: string
}

// Main signIn function (for compatibility with existing code)
export async function signIn(email: string, password: string) {
  try {
    console.log("üîê Iniciando processo de login para:", email)

    // Verificar se o usu√°rio existe no banco de dados
    const { data: users, error: fetchError } = await supabase
      .from("user_profiles")
      .select("*")
      .eq("email", email.trim().toLowerCase())
      .eq("status", "active")

    if (fetchError || !users || users.length === 0) {
      console.error("‚ùå Usu√°rio n√£o encontrado ou inativo:", fetchError?.message)
      return {
        user: null,
        error: { message: "Usu√°rio n√£o encontrado ou inativo" },
      }
    }

    const userProfile = users[0]
    console.log("üë§ Usu√°rio encontrado:", userProfile.email)

    // Verificar a senha
    if (userProfile.password_hash) {
      console.log("üîç Verificando senha com hash...")

      // Verificar se a senha est√° hasheada (come√ßa com $2a$, $2b$, etc.)
      const isHashed = userProfile.password_hash.startsWith("$2")

      let passwordMatch = false

      if (isHashed) {
        // Senha hasheada - usar bcrypt.compare
        passwordMatch = await bcrypt.compare(password, userProfile.password_hash)
        console.log("üîê Compara√ß√£o com bcrypt:", passwordMatch ? "‚úÖ Sucesso" : "‚ùå Falhou")
      } else {
        // Senha em texto plano (usu√°rios antigos) - compara√ß√£o direta
        passwordMatch = userProfile.password_hash === password
        console.log("üìù Compara√ß√£o texto plano:", passwordMatch ? "‚úÖ Sucesso" : "‚ùå Falhou")
      }

      if (passwordMatch) {
        console.log("‚úÖ Login bem-sucedido!")

        const user = {
          id: userProfile.id,
          email: userProfile.email,
          full_name: userProfile.full_name,
          role: userProfile.role,
        }

        // Atualizar √∫ltimo login
        await supabase
          .from("user_profiles")
          .update({ last_login_at: new Date().toISOString() })
          .eq("id", userProfile.id)

        return {
          user,
          error: null,
        }
      }
    } else if (!userProfile.password_hash && password === "impa@senha2025") {
      // Fallback para usu√°rios sem senha definida (senha padr√£o)
      console.warn(`‚ö†Ô∏è Usu√°rio ${email} usando senha padr√£o`)

      const user = {
        id: userProfile.id,
        email: userProfile.email,
        full_name: userProfile.full_name,
        role: userProfile.role,
      }

      await supabase.from("user_profiles").update({ last_login_at: new Date().toISOString() }).eq("id", userProfile.id)

      return { user, error: null }
    }

    console.warn(`‚ùå Senha incorreta para ${email}`)
    return {
      user: null,
      error: { message: "Senha incorreta" },
    }
  } catch (error: any) {
    console.error("üí• Erro no login:", error.message)
    return {
      user: null,
      error: { message: "Erro interno do servidor" },
    }
  }
}

// Alternative login function
export async function loginUser(
  credentials: LoginCredentials,
): Promise<{ success: boolean; user?: any; error?: string }> {
  const result = await signIn(credentials.email, credentials.password)

  if (result.error) {
    return { success: false, error: result.error.message }
  }

  return { success: true, user: result.user }
}

export async function registerUser(userData: RegisterData): Promise<{ success: boolean; user?: any; error?: string }> {
  try {
    const { email, password, full_name } = userData

    // Verificar se o email j√° existe
    const { data: existingUsers, error: checkError } = await supabase
      .from("user_profiles")
      .select("id")
      .eq("email", email.toLowerCase())

    if (checkError) {
      console.error("Erro ao verificar email:", checkError)
      return { success: false, error: "Erro interno do servidor" }
    }

    if (existingUsers && existingUsers.length > 0) {
      return { success: false, error: "Este email j√° est√° em uso" }
    }

    // Hash da senha
    const saltRounds = 10
    const password_hash = await bcrypt.hash(password, saltRounds)

    // Criar usu√°rio
    const { data: newUser, error: insertError } = await supabase
      .from("user_profiles")
      .insert([
        {
          email: email.toLowerCase(),
          password_hash,
          full_name,
          role: "user",
          status: "active",
        },
      ])
      .select()
      .single()

    if (insertError) {
      console.error("Erro ao criar usu√°rio:", insertError)
      return { success: false, error: "Erro ao criar conta" }
    }

    // Criar configura√ß√µes padr√£o do usu√°rio
    await supabase.from("user_settings").insert([
      {
        user_id: newUser.id,
        agents_limit: 5,
        transcribe_audio_enabled: true,
        understand_images_enabled: true,
        voice_response_enabled: true,
        calendar_integration_enabled: true,
        vector_store_enabled: true,
      },
    ])

    // Remover senha do objeto retornado
    const { password_hash: _, ...userWithoutPassword } = newUser

    return { success: true, user: userWithoutPassword }
  } catch (error) {
    console.error("Erro no registro:", error)
    return { success: false, error: "Erro interno do servidor" }
  }
}

export function getCurrentUser(): UserProfile | null {
  if (typeof window === "undefined") return null

  try {
    const userStr = localStorage.getItem("user")
    if (!userStr) return null

    return JSON.parse(userStr)
  } catch (error) {
    console.error("Erro ao obter usu√°rio atual:", error)
    return null
  }
}

export function setCurrentUser(user: UserProfile): void {
  if (typeof window === "undefined") return

  try {
    localStorage.setItem("user", JSON.stringify(user))
  } catch (error) {
    console.error("Erro ao salvar usu√°rio:", error)
  }
}

export function clearCurrentUser(): void {
  if (typeof window === "undefined") return

  try {
    localStorage.removeItem("user")
  } catch (error) {
    console.error("Erro ao limpar usu√°rio:", error)
  }
}

// For compatibility with existing code
export async function signOut() {
  clearCurrentUser()
}

export async function updateUserProfile(
  userId: string,
  updates: Partial<UserProfile>,
): Promise<{ success: boolean; error?: string }> {
  try {
    const { error } = await supabase.from("user_profiles").update(updates).eq("id", userId)

    if (error) {
      console.error("Erro ao atualizar perfil:", error)
      return { success: false, error: "Erro ao atualizar perfil" }
    }

    return { success: true }
  } catch (error) {
    console.error("Erro ao atualizar perfil:", error)
    return { success: false, error: "Erro interno do servidor" }
  }
}
