"use client"

import { createContext, useContext } from "react"
import { supabase } from "./supabase"

export interface ThemeConfig {
  id?: string
  systemName: string
  primaryColor: string
  secondaryColor: string
  accentColor: string
  logoIcon: string
  sidebarStyle: "light" | "dark"
  brandingEnabled: boolean
  description?: string
}

export const defaultTheme: ThemeConfig = {
  systemName: "Impa AI",
  primaryColor: "#2563eb", // blue-600
  secondaryColor: "#10b981", // green-500
  accentColor: "#8b5cf6", // purple-500
  logoIcon: "ü§ñ",
  sidebarStyle: "light",
  brandingEnabled: true,
  description: "Plataforma de constru√ß√£o de agentes de IA",
}

export const ThemeContext = createContext<{
  theme: ThemeConfig
  updateTheme: (updates: Partial<ThemeConfig>) => Promise<void>
  loadTheme: () => Promise<void>
}>({
  theme: defaultTheme,
  updateTheme: async () => {},
  loadTheme: async () => {},
})

export const useTheme = () => useContext(ThemeContext)

// Fun√ß√£o para aplicar cores CSS customizadas
export const applyThemeColors = (theme: ThemeConfig) => {
  const root = document.documentElement
  root.style.setProperty("--primary-color", theme.primaryColor)
  root.style.setProperty("--secondary-color", theme.secondaryColor)
  root.style.setProperty("--accent-color", theme.accentColor)
}

// Fun√ß√£o para carregar tema do banco de dados
export const loadThemeFromDatabase = async (): Promise<ThemeConfig> => {
  try {
    const { data, error } = await supabase
      .from("global_theme_config")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(1)
      .single()

    if (error || !data) {
      console.log("Usando tema padr√£o")
      return defaultTheme
    }

    return {
      id: data.id,
      systemName: data.system_name,
      primaryColor: data.primary_color,
      secondaryColor: data.secondary_color,
      accentColor: data.accent_color,
      logoIcon: data.logo_icon,
      sidebarStyle: data.sidebar_style as "light" | "dark",
      brandingEnabled: data.branding_enabled,
      description: data.description || defaultTheme.description,
    }
  } catch (error) {
    console.error("Erro ao carregar tema:", error)
    return defaultTheme
  }
}

// Fun√ß√£o para salvar tema no banco de dados
export const saveThemeToDatabase = async (theme: Partial<ThemeConfig>): Promise<void> => {
  try {
    // Primeiro, verificar se j√° existe uma configura√ß√£o
    const { data: existing } = await supabase
      .from("global_theme_config")
      .select("id")
      .order("created_at", { ascending: false })
      .limit(1)
      .single()

    const themeData = {
      system_name: theme.systemName,
      primary_color: theme.primaryColor,
      secondary_color: theme.secondaryColor,
      accent_color: theme.accentColor,
      logo_icon: theme.logoIcon,
      sidebar_style: theme.sidebarStyle,
      branding_enabled: theme.brandingEnabled,
      description: theme.description,
    }

    if (existing) {
      // Atualizar configura√ß√£o existente
      const { error } = await supabase.from("global_theme_config").update(themeData).eq("id", existing.id)

      if (error) throw error
    } else {
      // Criar nova configura√ß√£o
      const { error } = await supabase.from("global_theme_config").insert([themeData])

      if (error) throw error
    }
  } catch (error) {
    console.error("Erro ao salvar tema:", error)
    throw error
  }
}

// Predefini√ß√µes de temas
export const themePresets = {
  blue: {
    systemName: "Impa AI",
    primaryColor: "#2563eb",
    secondaryColor: "#10b981",
    accentColor: "#8b5cf6",
    logoIcon: "ü§ñ",
    description: "Plataforma de constru√ß√£o de agentes de IA",
  },
  green: {
    systemName: "Impa AI",
    primaryColor: "#059669",
    secondaryColor: "#2563eb",
    accentColor: "#f59e0b",
    logoIcon: "üå±",
    description: "Plataforma de constru√ß√£o de agentes de IA",
  },
  purple: {
    systemName: "Impa AI",
    primaryColor: "#7c3aed",
    secondaryColor: "#ec4899",
    accentColor: "#06b6d4",
    logoIcon: "üíú",
    description: "Plataforma de constru√ß√£o de agentes de IA",
  },
  orange: {
    systemName: "Impa AI",
    primaryColor: "#ea580c",
    secondaryColor: "#dc2626",
    accentColor: "#7c2d12",
    logoIcon: "üî•",
    description: "Plataforma de constru√ß√£o de agentes de IA",
  },
}
